name: Create package on release

on: create

env:
  GRIDDB_SERVER_NAME: "griddb"
  GRIDDB_NOTIFICATION_ADDRESS: "239.0.0.1"
  GRIDDB_NOTIFICATION_PORT: "31999"
  GRIDDB_USERNAME: "admin"
  GRIDDB_PASSWORD: "admin"
  GRIDDB_PACKAGE_NAME: "griddb"
      matrix:
       include:
         - os: Ubuntu
           container: duongntt/griddb-ubuntu-18.04
         - os: Centos
           container: duongntt/griddb-centos7
         - os: Opensuse
           container: duongntt/griddb-opensuse-15.1
jobs:
  release_package:
    name: Create and release rpm file for ${{ matrix.os }}
    runs-on: ubuntu-18.04
    container:
      image:  ${{ matrix.os.container }}
    steps:
      - uses: actions/checkout@v1
      - name: Build Griddb server
        run: . .github/workflows/script/function.sh && build_griddb
      - name: Create rpm for CentOS
        run: . .github/workflows/script/function.sh && build_rpm
      - name: Check package information
        run: rpm -qip installer/RPMS/x86_64/griddb-*-linux.x86_64.rpm
      - name: Install package
        run: . .github/workflows/script/function.sh && install_griddb
      - name: Config GridDB server
        run: . .github/workflows/script/function.sh \
             && config_griddb ${GRIDDB_USERNAME} ${GRIDDB_PASSWORD} ${GRIDDB_SERVER_NAME}
      - name: Start server
        run: . .github/workflows/script/function.sh \
             && start_griddb ${GRIDDB_USERNAME} ${GRIDDB_PASSWORD} ${GRIDDB_SERVER_NAME}
      - name: Run sample
        run: . .github/workflows/script/function.sh \
             && run_sample ${GRIDDB_NOTIFICATION_ADDRESS} ${GRIDDB_NOTIFICATION_PORT}  \
                 ${GRIDDB_SERVER_NAME} ${GRIDDB_USERNAME} ${GRIDDB_PASSWORD}
      - name: Stop server
        run: . .github/workflows/script/function.sh \
             && stop_griddb ${GRIDDB_USERNAME} ${GRIDDB_PASSWORD}
      - name: Uninstall package
        run: rpm -e ${GRIDDB_PACKAGE_NAME}
      - name: Upload rpm file
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: installer/RPMS/x86_64/griddb-*-linux.x86_64.rpm
          tag: ${{ github.ref }}
          overwrite: true
          file_glob: true

